{# templates/dte/factura_detail.html #}
{% extends "productos/base.html" %}
{% load humanize %}

{% block title %}{{ factura.identificacion.numeroControl }} - Detalle{% endblock %}

{% block content %}
<div class="container">
  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h1 class="page-title mb-1">
        <i class="fas fa-file-invoice text-primary me-2"></i>
        {{ factura.identificacion.numeroControl }}
      </h1>
      <div class="d-flex align-items-center gap-3">
        {% if factura.estado_hacienda == 'ACEPTADO' %}
        <span class="badge bg-success fs-6">
          <i class="fas fa-check-circle me-1"></i>Aceptado por Hacienda
        </span>
        {% elif factura.estado_hacienda == 'ACEPTADO_CON_OBSERVACIONES' %}
        <span class="badge bg-success fs-6">
          <i class="fas fa-check-circle me-1"></i>Aceptado con Observaciones
        </span>
        {% elif factura.estado_hacienda == 'RECHAZADO' %}
        <span class="badge bg-danger fs-6">
          <i class="fas fa-times-circle me-1"></i>Rechazado por Hacienda
        </span>
        {% elif factura.estado_hacienda == 'NO_ENVIADO' %}
        <span class="badge bg-secondary fs-6">
          <i class="fas fa-clock me-1"></i>No Enviado
        </span>
        {% else %}
        <span class="badge bg-warning fs-6">
          <i class="fas fa-question-circle me-1"></i>{{ factura.estado_hacienda }}
        </span>
        {% endif %}

        {% if factura.sello_recepcion %}
        <span class="badge bg-success fs-6">
          <i class="fas fa-certificate me-1"></i>Con Sello
        </span>
        {% endif %}
      </div>
    </div>

    <div class="btn-group">
      <a href="{% url 'dte:factura_list' %}" class="btn btn-outline-secondary">
        <i class="fas fa-chevron-left me-1"></i>Volver
      </a>
        {% if factura.estado_hacienda == 'ACEPTADO' or factura.estado_hacienda == 'ACEPTADO_CON_OBSERVACIONES' %}
      <a href="{% url 'dte:descargar_factura_pdf' factura.pk %}" class="btn btn-success">
        <i class="fas fa-file-pdf me-1"></i>Descargar PDF
      </a>
      <a href="{% url 'dte:descargar_factura_json' factura.pk %}" class="btn btn-info">
        <i class="fas fa-file-code me-1"></i>Descargar JSON
      </a>
      {% endif %}
       {% if factura.identificacion.tipoDte.codigo == '03' and factura.estado_hacienda == 'ACEPTADO' or factura.estado_hacienda == 'ACEPTADO_CON_OBSERVACIONES' %}
      <!-- Botón para crear Nota de Crédito -->
      <a href="{% url 'dte:crear_nc_desde_documento' object.id %}" class="btn btn-warning">
        <i class="fas fa-minus-circle"></i> Crear Nota de Crédito
      </a>
      {% endif %}
    </div>
  </div>

  <div class="row">
    <!-- Información Principal -->
    <div class="col-lg-8">
      <!-- Identificación -->
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="card-title mb-0">
            <i class="fas fa-id-card text-primary me-2"></i>Identificación
          </h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <table class="table table-sm table-borderless">
                <tr>
                  <td class="fw-bold">Número de Control:</td>
                  <td>{{ factura.identificacion.numeroControl }}</td>
                </tr>
                <tr>
                  <td class="fw-bold">Código de Generación:</td>
                  <td><code>{{ factura.identificacion.codigoGeneracion }}</code></td>
                </tr>
                <tr>
                  <td class="fw-bold">Tipo de Documento:</td>
                  <td>{{ factura.identificacion.tipoDte }}</td>
                </tr>
                <tr>
                  <td class="fw-bold">Modelo de Facturación:</td>
                  <td>{{ factura.identificacion.tipoModelo }}</td>
                </tr>
              </table>
            </div>
            <div class="col-md-6">
              <table class="table table-sm table-borderless">
                <tr>
                  <td class="fw-bold">Fecha de Emisión:</td>
                  <td>{{ factura.identificacion.fecEmi|date:"d/m/Y" }}</td>
                </tr>
                <tr>
                  <td class="fw-bold">Hora de Emisión:</td>
                  <td>{{ factura.identificacion.horEmi|time:"H:i:s" }}</td>
                </tr>
                <tr>
                  <td class="fw-bold">Tipo de Transmisión:</td>
                  <td>{{ factura.identificacion.tipoOperacion }}</td>
                </tr>
                <tr>
                  <td class="fw-bold">Ambiente:</td>
                  <td>{{ factura.identificacion.ambiente }}</td>
                </tr>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Emisor y Receptor -->
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="card-title mb-0">
            <i class="fas fa-users text-primary me-2"></i>Emisor y Receptor
          </h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <h6 class="fw-bold text-primary mb-3">EMISOR</h6>
              <table class="table table-sm table-borderless">
                <tr>
                  <td class="fw-bold">Nombre:</td>
                  <td>{{ factura.emisor.nombre }}</td>
                </tr>
                <tr>
                  <td class="fw-bold">NIT:</td>
                  <td>{{ factura.emisor.nit }}</td>
                </tr>
                <tr>
                  <td class="fw-bold">NRC:</td>
                  <td>{{ factura.emisor.nrc }}</td>
                </tr>
                <tr>
                  <td class="fw-bold">Actividad:</td>
                  <td>{{ factura.emisor.descActividad }}</td>
                </tr>
                <tr>
                  <td class="fw-bold">Teléfono:</td>
                  <td>{{ factura.emisor.telefono }}</td>
                </tr>
                <tr>
                  <td class="fw-bold">Email:</td>
                  <td>{{ factura.emisor.correo }}</td>
                </tr>
              </table>
            </div>
            <div class="col-md-6">
              <h6 class="fw-bold text-success mb-3">RECEPTOR</h6>
              <table class="table table-sm table-borderless">
                <tr>
                  <td class="fw-bold">Nombre:</td>
                  <td>{{ factura.receptor.nombre }}</td>
                </tr>
                <tr>
                  <td class="fw-bold">Tipo Doc:</td>
                  <td>{{ factura.receptor.tipoDocumento }}</td>
                </tr>
                <tr>
                  <td class="fw-bold">N° Documento:</td>
                  <td>{{ factura.receptor.numDocumento }}</td>
                </tr>
                {% if factura.receptor.nrc %}
                <tr>
                  <td class="fw-bold">NRC:</td>
                  <td>{{ factura.receptor.nrc }}</td>
                </tr>
                {% endif %}
                <tr>
                  <td class="fw-bold">Teléfono:</td>
                  <td>{{ factura.receptor.telefono|default:"N/A" }}</td>
                </tr>
                <tr>
                  <td class="fw-bold">Email:</td>
                  <td>{{ factura.receptor.correo|default:"N/A" }}</td>
                </tr>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Items de la Factura -->
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="card-title mb-0">
            <i class="fas fa-list text-primary me-2"></i>Ítems de la Factura
          </h5>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-hover mb-0">
              <thead class="table-light">
                <tr>
                  <th>#</th>
                  <th>Descripción</th>
                  <th>Cantidad</th>
                  <th>Unidad</th>
                  <th class="text-end">Precio Unit.</th>
                  <th class="text-end">Descuento</th>
                  <th class="text-end">V. Gravadas</th>
                  <th class="text-end">V. Exentas</th>
                </tr>
              </thead>
              <tbody>
                {% for item in factura.cuerpo_documento.all %}
                <tr>
                  <td>{{ item.numItem }}</td>
                  <td>
                    <div class="fw-bold">{{ item.descripcion }}</div>
                    {% if item.codigo %}
                    <small class="text-muted">Código: {{ item.codigo }}</small>
                    {% endif %}
                  </td>
                  <td>{{ item.cantidad|floatformat:2 }}</td>
                  <td>{{ item.uniMedida }}</td>
                  <td class="text-end">${{ item.precioUni|floatformat:2 }}</td>
                  <td class="text-end">${{ item.montoDescu|floatformat:2 }}</td>
                  <td class="text-end">${{ item.ventaGravada|floatformat:2 }}</td>
                  <td class="text-end">${{ item.ventaExenta|floatformat:2 }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Resumen Financiero -->
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="card-title mb-0">
            <i class="fas fa-calculator text-primary me-2"></i>Resumen Financiero
          </h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <table class="table table-sm table-borderless">
                <tr>
                  <td class="fw-bold">Total No Sujetas:</td>
                  <td class="text-end">${{ factura.resumen.totalNoSuj|floatformat:2 }}</td>
                </tr>
                <tr>
                  <td class="fw-bold">Total Exentas:</td>
                  <td class="text-end">${{ factura.resumen.totalExenta|floatformat:2 }}</td>
                </tr>
                <tr>
                  <td class="fw-bold">Total Gravadas:</td>
                  <td class="text-end">${{ factura.resumen.totalGravada|floatformat:2 }}</td>
                </tr>
                <tr>
                  <td class="fw-bold">Subtotal Ventas:</td>
                  <td class="text-end">${{ factura.resumen.subTotalVentas|floatformat:2 }}</td>
                </tr>
                <tr>
                  <td class="fw-bold">Total Descuentos:</td>
                  <td class="text-end">${{ factura.resumen.totalDescu|floatformat:2 }}</td>
                </tr>
              </table>
            </div>
            <div class="col-md-6">
              <table class="table table-sm table-borderless">
                <tr>
                  <td class="fw-bold">Subtotal:</td>
                  <td class="text-end">${{ factura.resumen.subTotal|floatformat:2 }}</td>
                </tr>
                {% for tributo in factura.resumen.tributos.all %}
                <tr>
                  <td class="fw-bold">{{ tributo.descripcion }}:</td>
                  <td class="text-end">${{ tributo.valor|floatformat:2 }}</td>
                </tr>
                {% endfor %}
                <tr>
                  <td class="fw-bold">IVA Retenido:</td>
                  <td class="text-end">${{ factura.resumen.ivaRete1|floatformat:2 }}</td>
                </tr>
                <tr>
                  <td class="fw-bold">Retención Renta:</td>
                  <td class="text-end">${{ factura.resumen.reteRenta|floatformat:2 }}</td>
                </tr>
                <tr class="border-top">
                  <td class="fw-bold fs-5 text-primary">TOTAL A PAGAR:</td>
                  <td class="text-end fw-bold fs-5 text-primary">${{ factura.resumen.totalPagar|floatformat:2 }}</td>
                </tr>
              </table>
            </div>
          </div>

          {% if factura.resumen.totalLetras %}
          <div class="mt-3 p-3 bg-light rounded">
            <strong>Valor en Letras:</strong> {{ factura.resumen.totalLetras }}
          </div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Panel Lateral -->
    <div class="col-lg-4">
      <!-- Código QR -->
      {% if tiene_sello %}
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="card-title mb-0">
            <i class="fas fa-qrcode text-primary me-2"></i>Verificación
          </h5>
        </div>
        <div class="card-body text-center">
          <div class="mb-3">
            <img src="data:image/png;base64,{{ qr_code }}" alt="Código QR" class="img-fluid" style="max-width: 200px;">
          </div>
          <p class="small text-muted mb-0">
            Escanea para verificar en el sitio oficial de Hacienda
          </p>
          <a href="{{ qr_url }}" target="_blank" class="btn btn-outline-primary btn-sm mt-2">
            <i class="fas fa-external-link-alt me-1"></i>Verificar Online
          </a>
        </div>
      </div>
      {% endif %}

      <!-- Información de Hacienda -->
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="card-title mb-0">
            <i class="fas fa-stamp text-primary me-2"></i>Estado en Hacienda
          </h5>
        </div>
        <div class="card-body">
          <table class="table table-sm table-borderless">
            <tr>
              <td class="fw-bold">Estado:</td>
              <td>
                {% if factura.estado_hacienda == 'ACEPTADO' %}
                <span class="badge bg-success">Aceptado</span>
                {% elif factura.estado_hacienda == 'ACEPTADO_CON_OBSERVACIONES' %}
                <span class="badge bg-success">Aceptado con Observaciones</span>
                {% elif factura.estado_hacienda == 'RECHAZADO' %}
                <span class="badge bg-danger">Rechazado</span>
                {% elif factura.estado_hacienda == 'NO_ENVIADO' %}
                <span class="badge bg-secondary">No Enviado</span>
                {% else %}
                <span class="badge bg-warning">{{ factura.estado_hacienda }}</span>
                {% endif %}
              </td>
            </tr>
            {% if factura.fecha_envio_hacienda %}
            <tr>
              <td class="fw-bold">Fecha Envío:</td>
              <td>{{ factura.fecha_envio_hacienda|date:"d/m/Y H:i" }}</td>
            </tr>
            {% endif %}
            {% if factura.fecha_procesamiento %}
            <tr>
              <td class="fw-bold">Procesado:</td>
              <td>{{ factura.fecha_procesamiento }}</td>
            </tr>
            {% endif %}
            {% if factura.sello_recepcion %}
            <tr>
              <td class="fw-bold">Sello:</td>
              <td>
                <code class="small">{{ factura.sello_recepcion|slice:":20" }}...</code>
              </td>
            </tr>
            {% endif %}
            <tr>
              <td class="fw-bold">Intentos:</td>
              <td>{{ factura.intentos_envio }}</td>
            </tr>
          </table>

          {% if factura.observaciones_hacienda %}
          <div class="mt-3">
            <h6 class="fw-bold text-warning">Observaciones:</h6>
            <div class="alert-warning small">
              {{ factura.observaciones_hacienda }}
            </div>
          </div>
          {% endif %}
        </div>
      </div>

      <!-- Información de Correo -->
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="card-title mb-0">
            <i class="fas fa-envelope text-primary me-2"></i>Envío por Correo
          </h5>
        </div>
        <div class="card-body">
          <table class="table table-sm table-borderless">
            <tr>
              <td class="fw-bold">Estado:</td>
              <td>
                {% if factura.enviado_por_correo %}
                <span class="badge bg-success">
                  <i class="fas fa-check me-1"></i>Enviado
                </span>
                {% else %}
                <span class="badge bg-secondary">
                  <i class="fas fa-times me-1"></i>No enviado
                </span>
                {% endif %}
              </td>
            </tr>
            {% if factura.fecha_envio_correo %}
            <tr>
              <td class="fw-bold">Fecha:</td>
              <td>{{ factura.fecha_envio_correo|date:"d/m/Y H:i" }}</td>
            </tr>
            {% endif %}
            <tr>
              <td class="fw-bold">Destinatario:</td>
              <td>{{ factura.receptor.correo|default:"Sin correo" }}</td>
            </tr>
          </table>
        </div>
      </div>

      <!-- Acciones Adicionales -->
      {% if factura.estado_hacienda == 'RECHAZADO' %}
      <div class="card border-warning">
        <div class="card-header bg-warning">
          <h5 class="card-title mb-0 text-dark">
            <i class="fas fa-exclamation-triangle me-2"></i>Acciones
          </h5>
        </div>
        <div class="card-body">
          <p class="text-muted small">
            La factura fue rechazada por Hacienda. Puede intentar reenviarla después de revisar las observaciones.
          </p>
          <a href="{% url 'dte:reenviar_factura' factura.pk %}" class="btn btn-warning btn-sm">
            <i class="fas fa-redo me-1"></i>Reenviar a Hacienda
          </a>
        </div>
      </div>
      {% endif %}
    </div>
  </div>

  <!-- Sección JSON (colapsable) -->
  <div class="card">
    <div class="card-header">
      <h5 class="card-title mb-0">
        <button class="btn btn-link p-0 text-decoration-none" type="button" data-bs-toggle="collapse"
          data-bs-target="#jsonCollapse">
          <i class="fas fa-code text-primary me-2"></i>JSON del Documento
          <i class="fas fa-chevron-down ms-1"></i>
        </button>
      </h5>
    </div>
    <div class="collapse" id="jsonCollapse">
      <div class="card-body">
        <div class="d-flex justify-content-end mb-2">
          <button class="btn btn-outline-secondary btn-sm" onclick="copyToClipboard()">
            <i class="fas fa-copy me-1"></i>Copiar JSON
          </button>
        </div>
        <pre id="jsonContent" style="max-height:400px; overflow:auto; background:#f8f9fa; border-radius:6px;"
          class="p-3"><code>{{ json }}</code></pre>
      </div>
    </div>
  </div>

  <!-- Sello de Recepción (si existe) -->
  {% if factura.sello_recepcion %}
  <div class="card mt-4">
    <div class="card-header">
      <h5 class="card-title mb-0">
        <i class="fas fa-certificate text-success me-2"></i>Sello de Recepción
      </h5>
    </div>
    <div class="card-body">
      <div class="">
        <h6 class="">Documento Validado por Hacienda</h6>
        <p class="mb-0">
          <strong>Sello:</strong> <code>{{ factura.sello_recepcion }}</code>
        </p>
        {% if factura.fecha_procesamiento %}
        <hr>
        <p class="mb-0">
          <strong>Fecha de Procesamiento:</strong> {{ factura.fecha_procesamiento }}
        </p>
        {% endif %}
      </div>
    </div>
  </div>
  {% endif %}
</div>

<script>
  function copyToClipboard() {
    const jsonContent = document.getElementById('jsonContent').textContent;
    navigator.clipboard.writeText(jsonContent).then(function () {
      // Mostrar mensaje de éxito
      const button = event.target.closest('button');
      const originalText = button.innerHTML;
      button.innerHTML = '<i class="fas fa-check me-1"></i>Copiado';
      button.classList.remove('btn-outline-secondary');
      button.classList.add('btn-success');

      setTimeout(() => {
        button.innerHTML = originalText;
        button.classList.remove('btn-success');
        button.classList.add('btn-outline-secondary');
      }, 2000);
    });
  }
</script>
{% endblock %}